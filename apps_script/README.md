# Apps Script（SwitchBot 環境ログ記録）

Google スプレッドシートと Apps Script を使い、SwitchBot の温湿度・CO2 データを定期的に記録するためのコードと設定をまとめたディレクトリです。

---

## 概要

- **目的**: SwitchBot API から温湿度・CO2 を取得し、スプレッドシートの `log` シートに 5 分ごとに追記する。
- **トリガー**: 時間主導型（5 分間隔）で `recordEnvironment` を実行。
- **データ保持**: ヘッダー含め約 2017 行まで保持し、それを超えた分は古い行から削除（約 1 週間分）。

---

## ファイル構成

| ファイル | 役割 |
|----------|------|
| `src/code.gs` | メイン処理。`recordEnvironment`（log シートへの記録）、`fetchCurrentEnv`（SwitchBot API 呼び出し）。 |
| `src/util.gs` | API 用の定数（トークン・シークレット・デバイス ID）と署名・Nonce 用のヘルパー関数。 |

---

## 1. util.gs の設定（トークン・デバイス ID）

SwitchBot API の認証情報とデバイス ID を **`src/util.gs`** に設定します。

| 定数 | 説明 | 設定例 |
|------|------|--------|
| `token` | SwitchBot の API トークン | `"****"`（App から取得） |
| `secret` | API シークレット（署名計算に使用） | `"****"`（App から取得） |
| `device_id` | 温湿度計（または CO2 対応デバイス）のデバイス ID | `"****"`（API 経由で取得） |

**取得方法**は以下の記事を参照してください。

- [【SwitchBot API+ GAS】温度と湿度から不快指数を快適に保つ！　エアコンの自動操作](https://qiita.com/shiot/items/87d09495e3c3a2c1bdaf)

※ `util.gs` には機密情報が含まれるため、リポジトリにコミットする場合は `****` のままにし、実際の値は GAS のエディタ上でのみ設定することを推奨します。

---

## 2. スプレッドシートの準備

- この Apps Script は **「現在開いているスプレッドシート」**（`SpreadsheetApp.getActiveSpreadsheet()`）に対して動作します。
- 初回実行時に `log` という名前のシートがなければ自動作成されます。

### switchbot-gas スプレッドシートの「log」シートの形式

| 列 | 意味 | 例 |
|----|------|-----|
| A | `timestamp`（UNIX 秒） | `1739251200` |
| B | `temp`（温度） | `24.5` |
| C | `humid`（湿度） | `55` |
| D | `co2`（CO2） | `800` |

- **1 行目**: ヘッダー（`timestamp`, `temperature`, `humidity`, `co2`）。コードが自動作成する。
- **2 行目以降**: 新しいデータが常に 2 行目に挿入され、古いデータは下にずれる。
- **最大行数**: ヘッダー含めて 2017 行（約 2016 件のデータ）。これを超えると古い行から削除される。

```
A列        B列   C列   D列
----------------------------------
timestamp  temp  humid co2
data0
data1
...
data2015
data2016
```

---

## 3. トリガー設定

Apps Script エディタで **「トリガー」** を次のように設定します。

| 項目 | 設定値 |
|------|--------|
| 実行する関数 | `recordEnvironment` |
| デプロイ時に実行 | **Head**（現在のプロジェクトの先頭バージョン） |
| イベントのソース | **時間主導型** |
| 時間ベースのトリガーのタイプ | **分ベースのタイマー** |
| 時間の間隔（分） | **5 分おき** |
| エラー通知 | **今すぐ通知を受け取る**（推奨） |

設定手順: エディタ左メニュー **「トリガー」** → **「トリガーを追加」** で上記を選択。

---

## 4. デプロイ・実行の流れ

1. Google スプレッドシートを開き、**拡張機能** → **Apps Script** でプロジェクトを開く。
2. `src/code.gs` と `src/util.gs` の内容をそれぞれ GAS の `code.gs`・`util.gs`（または同名の .gs ファイル）にコピーする。
3. `util.gs` の `token`・`secret`・`device_id` を実際の値に書き換える。
4. トリガーを上記のとおり追加する。
5. 初回は手動で `recordEnvironment` を実行して動作確認するとよい。

---

## 5. フロント（このリポジトリの Web アプリ）との関係

- フロントの `sheetApi.ts` は、この「log」シートのデータを **gviz（JSON）** で取得し、グラフ表示などに利用しています。
- 列構成（A: timestamp, B: 温度, C: 湿度, D: CO2）とヘッダー名は、Apps Script と `sheetApi.ts` で一致させてください。
